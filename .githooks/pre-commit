#!/usr/bin/env bash
# Pre-commit hook: blocks commits containing secrets.
#
# Install: git config core.hooksPath .githooks
# Or run: cp .githooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

echo "Running secret leak check..."

# Files being committed (staged)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

FOUND_SECRETS=0

# Pattern checks on staged file contents
while IFS= read -r file; do
    # Skip binary files
    if file "$file" | grep -q "binary"; then
        continue
    fi

    # Skip this hook file itself
    if [ "$file" = ".githooks/pre-commit" ]; then
        continue
    fi

    # Check for private keys (0x + 64 hex chars)
    if git diff --cached -- "$file" | grep -qE '0x[0-9a-fA-F]{64}'; then
        echo -e "${RED}BLOCKED${NC}: Possible private key in $file"
        FOUND_SECRETS=1
    fi

    # Check for API keys (sk_ or sk- prefix)
    if git diff --cached -- "$file" | grep -qE 'sk[_-][a-zA-Z0-9]{20,}'; then
        echo -e "${RED}BLOCKED${NC}: Possible API key in $file"
        FOUND_SECRETS=1
    fi

    # Check for Telegram bot tokens
    if git diff --cached -- "$file" | grep -qE '[0-9]{8,}:[A-Za-z0-9_-]{30,}'; then
        echo -e "${RED}BLOCKED${NC}: Possible Telegram token in $file"
        FOUND_SECRETS=1
    fi

    # Check for .env files being committed (except .env.example)
    if [[ "$file" == ".env" || "$file" == ".env."* ]] && [[ "$file" != ".env.example" ]]; then
        echo -e "${RED}BLOCKED${NC}: Attempting to commit secret file: $file"
        FOUND_SECRETS=1
    fi

    # Check for common secret patterns in added lines
    if git diff --cached -- "$file" | grep -qEi '(password|secret|token|api.?key)\s*[:=]\s*["\x27][^"\x27]{8,}'; then
        echo -e "${RED}BLOCKED${NC}: Possible hardcoded secret in $file"
        FOUND_SECRETS=1
    fi

done <<< "$STAGED_FILES"

if [ $FOUND_SECRETS -ne 0 ]; then
    echo ""
    echo -e "${RED}Commit blocked: potential secrets detected.${NC}"
    echo "If these are false positives, use: git commit --no-verify"
    echo "But VERIFY first â€” leaked keys = drained wallet."
    exit 1
fi

echo -e "${GREEN}No secrets detected. Commit OK.${NC}"
exit 0
